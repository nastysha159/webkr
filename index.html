<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Ä—Å–∫–æ–π –ë–æ–π</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –≤–∞—à–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 600px;
        }

        .sidebar {
            background: #34495e;
            color: white;
            padding: 20px;
        }

        .game-area {
            padding: 20px;
            background: #ecf0f1;
        }

        .rooms-list {
            margin-bottom: 20px;
        }

        .room-item {
            background: #4a6278;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .room-item:hover {
            background: #5a7288;
        }

        .room-item.full {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .room-item.started {
            background: #e74c3c;
        }

        .boards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .board-section {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .board-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2c3e50;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            grid-template-rows: repeat(10, 30px);
            gap: 1px;
            margin: 0 auto;
            background: #bdc3c7;
            padding: 2px;
            border-radius: 3px;
        }

        .cell {
            width: 30px;
            height: 30px;
            background: #3498db;
            border: 1px solid #2980b9;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .cell.ship {
            background: #2c3e50;
        }

        .cell.hit {
            background: #e74c3c;
            color: white;
        }

        .cell.miss {
            background: #ecf0f1;
        }

        .cell.ship.hit {
            background: #c0392b;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .chat-container {
            background: white;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }

        .chat-messages {
            height: 150px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.waiting {
            background: #f39c12;
            color: white;
        }

        .status.ready {
            background: #27ae60;
            color: white;
        }

        .status.your-turn {
            background: #2ecc71;
            color: white;
        }

        .status.opponent-turn {
            background: #e74c3c;
            color: white;
        }

        .ship-placing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .ship-list {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .ship-item {
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }

        .ship-item.selected {
            background: #e74c3c;
        }

        .ship-item.placed {
            background: #27ae60;
        }

        .orientation-btn {
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .chat-message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            background: #f8f9fa;
        }

        .chat-message.own {
            background: #e3f2fd;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ú–æ—Ä—Å–∫–æ–π –ë–æ–π —Å Redis</h1>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="rooms-list">
                    <h3>–ö–æ–º–Ω–∞—Ç—ã</h3>
                    <div id="roomsContainer"></div>
                </div>
                
                <div class="player-info">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div id="playerStatus" class="status">–ù–µ –≤ –∫–æ–º–Ω–∞—Ç–µ</div>
                    <div id="gameStatus"></div>
                    <div id="playerId" style="font-size: 12px; margin-top: 10px; color: #bdc3c7;"></div>
                </div>
                
                <div class="controls">
                    <button id="leaveRoomBtn" class="hidden">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    <button id="refreshRoomsBtn">–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—ã</button>
                </div>
            </div>
            
            <div class="game-area">
                <div id="lobbyView">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –∏–≥—Ä—ã</h2>
                    <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –æ–¥–Ω–æ–π –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç. –í—Å–µ–≥–æ –∫–æ–º–Ω–∞—Ç: 5</p>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h3>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</h3>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—É—é –∫–æ–º–Ω–∞—Ç—É (0-1/2 –∏–≥—Ä–æ–∫–æ–≤)</li>
                            <li>–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –Ω–∞ —Å–≤–æ–µ–π –¥–æ—Å–∫–µ</li>
                            <li>–ü–æ –æ—á–µ—Ä–µ–¥–∏ —Å—Ç—Ä–µ–ª—è–π—Ç–µ –ø–æ –¥–æ—Å–∫–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</li>
                            <li>–ü–µ—Ä–≤—ã–π, –∫—Ç–æ –ø–æ—Ç–æ–ø–∏—Ç –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏, –ø–æ–±–µ–∂–¥–∞–µ—Ç!</li>
                        </ol>
                    </div>
                </div>
                
                <div id="gameView" class="hidden">
                    <div id="placementPhase" class="ship-placing hidden">
                        <h3>–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–æ—Ä–∞–±–ª–∏</h3>
                        <div class="ship-list" id="shipList">
                            <div class="ship-item" data-size="4">4-–ø–∞–ª—É–±–Ω—ã–π (1)</div>
                            <div class="ship-item" data-size="3">3-–ø–∞–ª—É–±–Ω—ã–π (2)</div>
                            <div class="ship-item" data-size="2">2-–ø–∞–ª—É–±–Ω—ã–π (3)</div>
                            <div class="ship-item" data-size="1">1-–ø–∞–ª—É–±–Ω—ã–π (4)</div>
                        </div>
                        <button id="rotateBtn" class="orientation-btn">–ü–æ–≤–µ—Ä–Ω—É—Ç—å: –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</button>
                        <button id="clearShipsBtn">–û—á–∏—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É</button>
                        <button id="placeShipsBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É</button>
                        <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥–æ—Å–∫—É —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ—Ä–∞–±–ª—å</p>
                        <p style="color: #666; font-size: 12px;">–î–æ—Å—Ç—É–ø–Ω–æ –∫–ª–µ—Ç–æ–∫ –¥–ª—è –∫–æ—Ä–∞–±–ª–µ–π: <span id="availableCells">20</span></p>
                    </div>
                    
                    <div class="boards-container">
                        <div class="board-section">
                            <div class="board-title">–í–∞—à–µ –ø–æ–ª–µ</div>
                            <div class="board" id="playerBoard"></div>
                            <div style="text-align: center; margin-top: 10px;">
                                <small>–ö–æ—Ä–∞–±–ª–∏: <span id="playerShipsCount">0/10</span></small>
                            </div>
                        </div>
                        
                        <div class="board-section">
                            <div class="board-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</div>
                            <div class="board" id="opponentBoard"></div>
                            <div style="text-align: center; margin-top: 10px;">
                                <small>–ü–æ–ø–∞–¥–∞–Ω–∏—è: <span id="opponentHits">0</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                –ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                            <button id="sendMessageBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BattleshipGame {
            constructor() {
                this.ws = null;
                this.playerId = null;
                this.roomId = null;
                this.gameState = 'lobby';
                this.currentShip = null;
                this.shipOrientation = 'horizontal';
                this.playerShips = [];
                this.availableShips = {
                    4: 1, // 1 –∫–æ—Ä–∞–±–ª—å 4-–ø–∞–ª—É–±–Ω—ã–π
                    3: 2, // 2 –∫–æ—Ä–∞–±–ª—è 3-–ø–∞–ª—É–±–Ω—ã—Ö
                    2: 3, // 3 –∫–æ—Ä–∞–±–ª—è 2-–ø–∞–ª—É–±–Ω—ã—Ö
                    1: 4  // 4 –∫–æ—Ä–∞–±–ª—è 1-–ø–∞–ª—É–±–Ω—ã—Ö
                };
                this.isMyTurn = false;
                this.shotsMade = new Set();
                this.opponentShots = new Set();
                
                this.initializeWebSocket();
                this.initializeEventListeners();
                this.renderBoards();
                this.updateShipCount();
            }
            
            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    document.getElementById('playerStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É';
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                        this.handleMessage(message);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                    document.getElementById('playerStatus').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    setTimeout(() => {
                        this.initializeWebSocket();
                    }, 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                };
            }
            
            initializeEventListeners() {
                // –ö–Ω–æ–ø–∫–∏
                document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                    this.leaveRoom();
                });
                
                document.getElementById('refreshRoomsBtn').addEventListener('click', () => {
                    this.sendMessage({ type: 'get_rooms' });
                });
                
                // –ß–∞—Ç
                document.getElementById('sendMessageBtn').addEventListener('click', () => {
                    this.sendChatMessage();
                });
                
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendChatMessage();
                    }
                });
                
                // –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π
                document.getElementById('rotateBtn').addEventListener('click', () => {
                    this.toggleShipOrientation();
                });
                
                document.getElementById('placeShipsBtn').addEventListener('click', () => {
                    this.confirmShipPlacement();
                });
                
                document.getElementById('clearShipsBtn').addEventListener('click', () => {
                    this.clearShips();
                });
                
                // –í—ã–±–æ—Ä –∫–æ—Ä–∞–±–ª—è –¥–ª—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
                document.getElementById('shipList').addEventListener('click', (e) => {
                    if (e.target.classList.contains('ship-item')) {
                        const size = parseInt(e.target.dataset.size);
                        if (!e.target.classList.contains('placed')) {
                            this.selectShip(size);
                        }
                    }
                });
            }
            
            handleMessage(message) {
                switch (message.type) {
                    case 'rooms_list':
                        this.updateRoomsList(message.rooms);
                        break;
                    case 'player_joined':
                        this.handlePlayerJoined(message);
                        break;
                    case 'player_left':
                        this.handlePlayerLeft(message);
                        break;
                    case 'game_starting':
                        this.startGame();
                        break;
                    case 'ships_placed_update':
                        this.updateShipsPlaced(message);
                        break;
                    case 'game_start':
                        this.gameStarted(message);
                        break;
                    case 'turn_change':
                        this.changeTurn(message);
                        break;
                    case 'shot_result':
                        this.handleShotResult(message);
                        break;
                    case 'game_over':
                        this.gameOver(message);
                        break;
                    case 'chat_message':
                        this.displayChatMessage(message);
                        break;
                    case 'ships_placed':
                        this.showMessage('–ö–æ—Ä–∞–±–ª–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã! –û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...');
                        break;
                    case 'error':
                        this.showError(message.message);
                        break;
                }
            }
            
            updateRoomsList(rooms) {
                const container = document.getElementById('roomsContainer');
                container.innerHTML = '';
                
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item';
                    roomElement.dataset.roomId = room.id;
                    
                    if (room.playersCount >= 2) {
                        roomElement.classList.add('full');
                    }
                    
                    if (room.gameStarted) {
                        roomElement.classList.add('started');
                    }
                    
                    roomElement.innerHTML = `
                        <div><strong>–ö–æ–º–Ω–∞—Ç–∞ ${room.id}</strong></div>
                        <div>–ò–≥—Ä–æ–∫–æ–≤: ${room.playersCount}/2</div>
                        <div>${room.gameStarted ? '–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞' : '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤'}</div>
                    `;
                    
                    if (room.playersCount < 2 && !room.gameStarted) {
                        roomElement.addEventListener('click', () => {
                            this.joinRoom(room.id);
                        });
                    }
                    
                    container.appendChild(roomElement);
                });
            }
            
            joinRoom(roomId) {
                this.sendMessage({
                    type: 'join_room',
                    roomId: parseInt(roomId)
                });
            }
            
            leaveRoom() {
                this.sendMessage({
                    type: 'leave_room'
                });
                
                this.showLobby();
            }
            
            handlePlayerJoined(message) {
                const statusElement = document.getElementById('playerStatus');
                statusElement.textContent = `–í –∫–æ–º–Ω–∞—Ç–µ: ${message.playersCount}/2 –∏–≥—Ä–æ–∫–æ–≤`;
                
                if (message.playersCount === 2) {
                    statusElement.className = 'status ready';
                } else {
                    statusElement.className = 'status waiting';
                }
                
                if (message.playerId) {
                    this.displayChatMessage({
                        playerId: 'system',
                        text: `–ò–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`,
                        timestamp: Date.now()
                    });
                }
            }
            
            handlePlayerLeft(message) {
                const statusElement = document.getElementById('playerStatus');
                statusElement.textContent = `–í –∫–æ–º–Ω–∞—Ç–µ: ${message.playersCount}/2 –∏–≥—Ä–æ–∫–æ–≤`;
                statusElement.className = 'status waiting';
                
                if (message.playersCount === 1) {
                    this.displayChatMessage({
                        playerId: 'system',
                        text: '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É. –û–∂–∏–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞...',
                        timestamp: Date.now()
                    });
                }
            }
            
            startGame() {
                this.gameState = 'placement';
                document.getElementById('placementPhase').classList.remove('hidden');
                document.getElementById('playerStatus').textContent = '–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏';
                document.getElementById('playerStatus').className = 'status waiting';
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —á–∞—Ç
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                
                this.clearShips();
                this.renderBoards();
            }
            
            updateShipsPlaced(message) {
                const statusElement = document.getElementById('playerStatus');
                statusElement.textContent = `–†–∞—Å—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–æ—Ä–∞–±–ª–µ–π: ${message.shipsPlaced}/2 –∏–≥—Ä–æ–∫–æ–≤`;
            }
            
            gameStarted(message) {
                this.gameState = 'battle';
                document.getElementById('placementPhase').classList.add('hidden');
                this.isMyTurn = message.currentPlayer === this.playerId;
                this.updateTurnDisplay();
                
                this.displayChatMessage({
                    playerId: 'system',
                    text: '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!',
                    timestamp: Date.now()
                });
            }
            
            changeTurn(message) {
                this.isMyTurn = message.currentPlayer === this.playerId;
                this.updateTurnDisplay();
                
                if (this.isMyTurn) {
                    this.displayChatMessage({
                        playerId: 'system',
                        text: '–í–∞—à —Ö–æ–¥!',
                        timestamp: Date.now()
                    });
                }
            }
            
            updateTurnDisplay() {
                const statusElement = document.getElementById('playerStatus');
                const chatInput = document.getElementById('chatInput');
                
                if (this.isMyTurn) {
                    statusElement.textContent = '–í–∞—à —Ö–æ–¥!';
                    statusElement.className = 'status your-turn';
                    chatInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
                } else {
                    statusElement.textContent = '–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
                    statusElement.className = 'status opponent-turn';
                    chatInput.placeholder = '–û–∂–∏–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ —Ö–æ–¥–∞...';
                }
            }
            
            handleShotResult(message) {
                const key = `${message.x},${message.y}`;
                
                if (message.hit) {
                    this.opponentShots.add(key);
                    this.displayChatMessage({
                        playerId: 'system',
                        text: `–ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ (${message.x + 1}, ${message.y + 1})!`,
                        timestamp: Date.now()
                    });
                    
                    if (message.shipSunk) {
                        this.displayChatMessage({
                            playerId: 'system',
                            text: '–ö–æ—Ä–∞–±–ª—å –ø–æ—Ç–æ–ø–ª–µ–Ω!',
                            timestamp: Date.now()
                        });
                    }
                } else {
                    this.displayChatMessage({
                        playerId: 'system',
                        text: `–ü—Ä–æ–º–∞—Ö –≤ (${message.x + 1}, ${message.y + 1})`,
                        timestamp: Date.now()
                    });
                }
                
                this.renderBoards();
                this.updateStats();
                
                if (message.gameOver) {
                    if (message.playerId === this.playerId) {
                        this.showMessage('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!');
                    } else {
                        this.showMessage('–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!');
                    }
                }
            }
            
            gameOver(message) {
                if (message.winner === this.playerId) {
                    this.showMessage('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!');
                    this.displayChatMessage({
                        playerId: 'system',
                        text: '–í—ã –ø–æ–±–µ–¥–∏–ª–∏!',
                        timestamp: Date.now()
                    });
                } else {
                    this.showMessage('üòû –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!');
                    this.displayChatMessage({
                        playerId: 'system',
                        text: '–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.',
                        timestamp: Date.now()
                    });
                }
                
                setTimeout(() => {
                    this.leaveRoom();
                }, 5000);
            }
            
            displayChatMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                
                messageElement.className = 'chat-message';
                if (message.playerId === this.playerId) {
                    messageElement.classList.add('own');
                }
                
                let sender = '–°–∏—Å—Ç–µ–º–∞';
                if (message.playerId === this.playerId) {
                    sender = '–í—ã';
                } else if (message.playerId && message.playerId !== 'system') {
                    sender = '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫';
                }
                
                const time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString() : '';
                messageElement.innerHTML = `
                    <div><strong>${sender}:</strong> ${message.text}</div>
                    ${time ? `<small style="color: #666;">${time}</small>` : ''}
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            sendChatMessage() {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                
                if (text) {
                    this.sendMessage({
                        type: 'chat_message',
                        text: text
                    });
                    input.value = '';
                }
            }
            
            selectShip(size) {
                if (this.availableShips[size] > 0) {
                    this.currentShip = size;
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ—Ä–∞–±–ª—å
                    document.querySelectorAll('.ship-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    const shipElement = document.querySelector(`.ship-item[data-size="${size}"]`);
                    if (shipElement) {
                        shipElement.classList.add('selected');
                    }
                }
            }
            
            toggleShipOrientation() {
                this.shipOrientation = this.shipOrientation === 'horizontal' ? 'vertical' : 'horizontal';
                document.getElementById('rotateBtn').textContent = 
                    `–ü–æ–≤–µ—Ä–Ω—É—Ç—å: ${this.shipOrientation === 'horizontal' ? '–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ' : '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ'}`;
            }
            
            clearShips() {
                this.playerShips = [];
                this.availableShips = {4: 1, 3: 2, 2: 3, 1: 4};
                this.currentShip = null;
                
                document.querySelectorAll('.ship-item').forEach(item => {
                    item.classList.remove('selected', 'placed');
                });
                
                this.renderBoards();
                this.updateShipCount();
            }
            
            confirmShipPlacement() {
                const totalShips = Object.values(this.availableShips).reduce((a, b) => a + b, 0);
                if (totalShips > 0) {
                    this.showError(`–ù—É–∂–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –µ—â–µ ${totalShips} –∫–æ—Ä–∞–±–ª–µ–π!`);
                    return;
                }
                
                if (this.playerShips.length !== 10) {
                    this.showError('–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏!');
                    return;
                }
                
                this.sendMessage({
                    type: 'place_ships',
                    ships: this.playerShips
                });
            }
            
            placeShipOnBoard(x, y) {
                if (!this.currentShip || this.gameState !== 'placement') return;
                
                if (this.availableShips[this.currentShip] <= 0) {
                    this.showError('–í—Å–µ –∫–æ—Ä–∞–±–ª–∏ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —É–∂–µ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã');
                    return;
                }
                
                if (this.canPlaceShip(x, y, this.currentShip, this.shipOrientation)) {
                    this.playerShips.push({
                        size: this.currentShip,
                        x: x,
                        y: y,
                        isHorizontal: this.shipOrientation === 'horizontal'
                    });
                    
                    this.availableShips[this.currentShip]--;
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∫–æ—Ä–∞–±–ª—å –∫–∞–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–π
                    const shipElement = document.querySelector(`.ship-item[data-size="${this.currentShip}"]`);
                    if (this.availableShips[this.currentShip] === 0) {
                        shipElement.classList.add('placed');
                    }
                    shipElement.classList.remove('selected');
                    
                    this.currentShip = null;
                    this.renderBoards();
                    this.updateShipCount();
                } else {
                    this.showError('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ä–∞–±–ª—å –∑–¥–µ—Å—å');
                }
            }
            
            canPlaceShip(x, y, size, orientation) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
                if (orientation === 'horizontal') {
                    if (x + size > 10) return false;
                } else {
                    if (y + size > 10) return false;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ—Ä–∞–±–ª—è–º–∏
                for (let i = 0; i < size; i++) {
                    const checkX = orientation === 'horizontal' ? x + i : x;
                    const checkY = orientation === 'horizontal' ? y : y + i;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ –∫–ª–µ—Ç–∫–∏
                    for (let dx = -1; dx <= 1; dx++) {
                        for (let dy = -1; dy <= 1; dy++) {
                            const neighborX = checkX + dx;
                            const neighborY = checkY + dy;
                            
                            if (neighborX >= 0 && neighborX < 10 && neighborY >= 0 && neighborY < 10) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–¥–µ—Å—å —É–∂–µ –∫–æ—Ä–∞–±–ª—å
                                for (const ship of this.playerShips) {
                                    for (let j = 0; j < ship.size; j++) {
                                        const shipX = ship.isHorizontal ? ship.x + j : ship.x;
                                        const shipY = ship.isHorizontal ? ship.y : ship.y + j;
                                        
                                        if (shipX === neighborX && shipY === neighborY) {
                                            return false;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                return true;
            }
            
            shoot(x, y) {
                if (this.gameState !== 'battle' || !this.isMyTurn) return;
                
                const key = `${x},${y}`;
                if (this.shotsMade.has(key)) {
                    this.showError('–í—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏ —Å—é–¥–∞!');
                    return;
                }
                
                this.shotsMade.add(key);
                this.sendMessage({
                    type: 'shoot',
                    x: x,
                    y: y
                });
            }
            
            renderBoards() {
                this.renderPlayerBoard();
                this.renderOpponentBoard();
            }
            
            renderPlayerBoard() {
                const board = document.getElementById('playerBoard');
                board.innerHTML = '';
                
                for (let y = 0; y < 10; y++) {
                    for (let x = 0; x < 10; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–¥–µ—Å—å –∫–æ—Ä–∞–±–ª—å
                        let hasShip = false;
                        for (const ship of this.playerShips) {
                            for (let i = 0; i < ship.size; i++) {
                                const shipX = ship.isHorizontal ? ship.x + i : ship.x;
                                const shipY = ship.isHorizontal ? ship.y : ship.y + i;
                                
                                if (shipX === x && shipY === y) {
                                    hasShip = true;
                                    break;
                                }
                            }
                            if (hasShip) break;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –≤—ã—Å—Ç—Ä–µ–ª
                        const key = `${x},${y}`;
                        const wasShot = this.opponentShots.has(key);
                        
                        if (hasShip && wasShot) {
                            cell.classList.add('ship', 'hit');
                            cell.textContent = 'üí•';
                        } else if (hasShip) {
                            cell.classList.add('ship');
                        } else if (wasShot) {
                            cell.classList.add('miss');
                            cell.textContent = '‚Ä¢';
                        }
                        
                        if (this.gameState === 'placement') {
                            cell.addEventListener('click', () => {
                                this.placeShipOnBoard(x, y);
                            });
                        }
                        
                        board.appendChild(cell);
                    }
                }
            }
            
            renderOpponentBoard() {
                const board = document.getElementById('opponentBoard');
                board.innerHTML = '';
                
                for (let y = 0; y < 10; y++) {
                    for (let x = 0; x < 10; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        
                        const key = `${x},${y}`;
                        const wasShot = this.shotsMade.has(key);
                        
                        if (wasShot) {
                            // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ —Å–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç, –±—ã–ª–æ –ª–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–µ
                            // –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Å—Ç—Ä–µ–ª—è–ª–∏
                            cell.classList.add('miss');
                            cell.textContent = '‚Ä¢';
                        }
                        
                        if (this.gameState === 'battle' && this.isMyTurn && !wasShot) {
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', () => {
                                this.shoot(x, y);
                            });
                        } else {
                            cell.style.cursor = 'default';
                        }
                        
                        board.appendChild(cell);
                    }
                }
            }
            
            updateShipCount() {
                const placedShips = 10 - Object.values(this.availableShips).reduce((a, b) => a + b, 0);
                document.getElementById('playerShipsCount').textContent = `${placedShips}/10`;
                document.getElementById('availableCells').textContent = placedShips;
            }
            
            updateStats() {
                document.getElementById('opponentHits').textContent = Array.from(this.shotsMade).length;
            }
            
            showLobby() {
                document.getElementById('lobbyView').classList.remove('hidden');
                document.getElementById('gameView').classList.add('hidden');
                document.getElementById('leaveRoomBtn').classList.add('hidden');
                document.getElementById('playerStatus').textContent = '–ù–µ –≤ –∫–æ–º–Ω–∞—Ç–µ';
                document.getElementById('playerStatus').className = 'status';
                
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —á–∞—Ç
                document.getElementById('chatInput').disabled = true;
                document.getElementById('sendMessageBtn').disabled = true;
                document.getElementById('chatInput').placeholder = '–í–æ–π–¥–∏—Ç–µ –≤ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —á–∞—Ç–∞';
                
                this.gameState = 'lobby';
                this.clearShips();
                this.shotsMade.clear();
                this.opponentShots.clear();
                this.updateStats();
            }
            
            showGame() {
                document.getElementById('lobbyView').classList.add('hidden');
                document.getElementById('gameView').classList.remove('hidden');
                document.getElementById('leaveRoomBtn').classList.remove('hidden');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ID –∏–≥—Ä–æ–∫–∞
                document.getElementById('playerId').textContent = `ID: ${this.playerId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
            }
            
            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                } else {
                    console.error('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                }
            }
            
            showError(message) {
                const statusElement = document.getElementById('playerStatus');
                const originalText = statusElement.textContent;
                statusElement.textContent = `–û—à–∏–±–∫–∞: ${message}`;
                statusElement.style.background = '#e74c3c';
                
                setTimeout(() => {
                    statusElement.textContent = originalText;
                    statusElement.style.background = '';
                }, 3000);
            }
            
            showMessage(message) {
                alert(message);
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            const game = new BattleshipGame();
            window.battleshipGame = game; // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        });
    </script>
</body>
</html>