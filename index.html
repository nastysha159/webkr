<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Ä—Å–∫–æ–π –ë–æ–π</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; min-height: 600px; }
        .sidebar { background: #34495e; color: white; padding: 20px; }
        .game-area { padding: 20px; background: #ecf0f1; }
        .rooms-list { margin-bottom: 20px; }
        .room-item { background: #4a6278; margin: 10px 0; padding: 15px; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .room-item:hover { background: #5a7288; }
        .room-item.full { background: #7f8c8d; cursor: not-allowed; }
        .room-item.started { background: #e74c3c; }
        .boards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .board-section { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .board-title { text-align: center; margin-bottom: 10px; font-weight: bold; color: #2c3e50; }
        .board { display: grid; grid-template-columns: repeat(10, 30px); grid-template-rows: repeat(10, 30px); gap: 1px; margin: 0 auto; background: #bdc3c7; padding: 2px; border-radius: 3px; }
        .cell { width: 30px; height: 30px; background: #3498db; border: 1px solid #2980b9; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .cell.ship { background: #2c3e50; }
        .cell.hit { background: #e74c3c; color: white; }
        .cell.miss { background: #ecf0f1; }
        .cell.ship.hit { background: #c0392b; }
        .controls { text-align: center; margin: 20px 0; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 0 5px; font-size: 14px; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .chat-container { background: white; border-radius: 5px; padding: 15px; margin-top: 20px; }
        .chat-messages { height: 150px; border: 1px solid #bdc3c7; border-radius: 5px; padding: 10px; margin-bottom: 10px; overflow-y: auto; }
        .chat-input { display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; }
        .status { text-align: center; padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.waiting { background: #f39c12; color: white; }
        .status.ready { background: #27ae60; color: white; }
        .status.your-turn { background: #2ecc71; color: white; }
        .status.opponent-turn { background: #e74c3c; color: white; }
        .ship-placing { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .ship-list { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .ship-item { padding: 5px 10px; background: #3498db; color: white; border-radius: 3px; cursor: pointer; }
        .ship-item.selected { background: #e74c3c; }
        .ship-item.placed { background: #27ae60; }
        .orientation-btn { margin: 10px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>–ú–æ—Ä—Å–∫–æ–π –ë–æ–π</h1></div>
        <div class="main-content">
            <div class="sidebar">
                <div class="rooms-list"><h3>–ö–æ–º–Ω–∞—Ç—ã</h3><div id="roomsContainer"></div></div>
                <div class="player-info"><h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3><div id="playerStatus" class="status">–ù–µ –≤ –∫–æ–º–Ω–∞—Ç–µ</div></div>
                <div class="controls">
                    <button id="leaveRoomBtn" class="hidden">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    <button id="refreshRoomsBtn">–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—ã</button>
                </div>
            </div>
            <div class="game-area">
                <div id="lobbyView"><h2>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –∏–≥—Ä—ã</h2><p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –æ–¥–Ω–æ–π –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p></div>
                <div id="gameView" class="hidden">
                    <div id="placementPhase" class="ship-placing hidden">
                        <h3>–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–æ—Ä–∞–±–ª–∏</h3>
                        <div class="ship-list" id="shipList">
                            <div class="ship-item" data-size="4">4-–ø–∞–ª—É–±–Ω—ã–π (1)</div>
                            <div class="ship-item" data-size="3">3-–ø–∞–ª—É–±–Ω—ã–π (2)</div>
                            <div class="ship-item" data-size="2">2-–ø–∞–ª—É–±–Ω—ã–π (3)</div>
                            <div class="ship-item" data-size="1">1-–ø–∞–ª—É–±–Ω—ã–π (4)</div>
                        </div>
                        <button id="rotateBtn" class="orientation-btn">–ü–æ–≤–µ—Ä–Ω—É—Ç—å: –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</button>
                        <button id="placeShipsBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É</button>
                        <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥–æ—Å–∫—É —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ—Ä–∞–±–ª—å</p>
                    </div>
                    <div class="boards-container">
                        <div class="board-section"><div class="board-title">–í–∞—à–µ –ø–æ–ª–µ</div><div class="board" id="playerBoard"></div></div>
                        <div class="board-section"><div class="board-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</div><div class="board" id="opponentBoard"></div></div>
                    </div>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                            <button id="sendMessageBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BattleshipGame {
            constructor() {
                this.ws = null;
                this.playerId = null;
                this.roomId = null;
                this.gameState = 'lobby';
                this.currentShip = null;
                this.shipOrientation = 'horizontal';
                this.playerShips = [];
                this.isMyTurn = false;
                this.initializeWebSocket();
                this.initializeEventListeners();
                this.renderBoards();
            }
            
            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                this.ws = new WebSocket(wsUrl);
                this.ws.onopen = () => console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };
                this.ws.onclose = () => {
                    console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                    setTimeout(() => this.initializeWebSocket(), 3000);
                };
                this.ws.onerror = (error) => console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            }
            
            initializeEventListeners() {
                document.getElementById('leaveRoomBtn').addEventListener('click', () => this.leaveRoom());
                document.getElementById('refreshRoomsBtn').addEventListener('click', () => this.sendMessage({ type: 'get_rooms' }));
                document.getElementById('sendMessageBtn').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.sendChatMessage(); });
                document.getElementById('rotateBtn').addEventListener('click', () => this.toggleShipOrientation());
                document.getElementById('placeShipsBtn').addEventListener('click', () => this.confirmShipPlacement());
                document.getElementById('shipList').addEventListener('click', (e) => {
                    if (e.target.classList.contains('ship-item')) this.selectShip(parseInt(e.target.dataset.size));
                });
            }
            
            handleMessage(message) {
                switch (message.type) {
                    case 'rooms_list': this.updateRoomsList(message.rooms); break;
                    case 'player_joined': this.updateRoomStatus(message); break;
                    case 'player_left': this.updateRoomStatus(message); break;
                    case 'game_starting': this.startGame(); break;
                    case 'ships_placed_update': this.updateShipsPlaced(message); break;
                    case 'game_start': this.gameStarted(message); break;
                    case 'turn_change': this.changeTurn(message); break;
                    case 'shot_result': this.handleShotResult(message); break;
                    case 'game_over': this.gameOver(message); break;
                    case 'chat_message': this.displayChatMessage(message); break;
                    case 'error': this.showError(message.message); break;
                }
            }
            
            updateRoomsList(rooms) {
                const container = document.getElementById('roomsContainer');
                container.innerHTML = '';
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item';
                    if (room.playersCount >= 2) roomElement.classList.add('full');
                    if (room.gameStarted) roomElement.classList.add('started');
                    roomElement.innerHTML = `<div>–ö–æ–º–Ω–∞—Ç–∞ ${room.id}</div><div>–ò–≥—Ä–æ–∫–æ–≤: ${room.playersCount}/2</div><div>${room.gameStarted ? '–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞' : '–û–∂–∏–¥–∞–Ω–∏–µ'}</div>`;
                    if (room.playersCount < 2 && !room.gameStarted) {
                        roomElement.addEventListener('click', () => this.joinRoom(room.id));
                    }
                    container.appendChild(roomElement);
                });
            }
            
            joinRoom(roomId) {
                this.sendMessage({ type: 'join_room', roomId: roomId });
            }
            
            leaveRoom() {
                this.sendMessage({ type: 'leave_room' });
                this.showLobby();
            }
            
            updateRoomStatus(message) {
                const statusElement = document.getElementById('playerStatus');
                statusElement.textContent = `–í –∫–æ–º–Ω–∞—Ç–µ: ${message.playersCount}/2 –∏–≥—Ä–æ–∫–æ–≤`;
                statusElement.className = message.playersCount === 2 ? 'status ready' : 'status waiting';
            }
            
            startGame() {
                this.gameState = 'placement';
                document.getElementById('placementPhase').classList.remove('hidden');
                document.getElementById('playerStatus').textContent = '–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏';
            }
            
            updateShipsPlaced(message) {
                document.getElementById('playerStatus').textContent = `–†–∞—Å—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–æ—Ä–∞–±–ª–µ–π: ${message.shipsPlaced}/2`;
            }
            
            gameStarted(message) {
                this.gameState = 'battle';
                document.getElementById('placementPhase').classList.add('hidden');
                this.isMyTurn = message.currentPlayer === this.playerId;
                this.updateTurnDisplay();
            }
            
            changeTurn(message) {
                this.isMyTurn = message.currentPlayer === this.playerId;
                this.updateTurnDisplay();
            }
            
            updateTurnDisplay() {
                const statusElement = document.getElementById('playerStatus');
                if (this.isMyTurn) {
                    statusElement.textContent = '–í–∞—à —Ö–æ–¥!';
                    statusElement.className = 'status your-turn';
                } else {
                    statusElement.textContent = '–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
                    statusElement.className = 'status opponent-turn';
                }
            }
            
            handleShotResult(message) {
                this.renderBoards();
                if (message.gameOver) {
                    if (message.playerId === this.playerId) {
                        this.showMessage('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!');
                    } else {
                        this.showMessage('–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!');
                    }
                }
            }
            
            gameOver(message) {
                if (message.winner === this.playerId) {
                    this.showMessage('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!');
                } else {
                    this.showMessage('üòû –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!');
                }
                setTimeout(() => this.leaveRoom(), 3000);
            }
            
            displayChatMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = `–ò–≥—Ä–æ–∫: ${message.text}`;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            sendChatMessage() {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (text) {
                    this.sendMessage({ type: 'chat_message', text: text });
                    input.value = '';
                }
            }
            
            selectShip(size) {
                this.currentShip = size;
                document.querySelectorAll('.ship-item').forEach(item => item.classList.remove('selected'));
                document.querySelector(`.ship-item[data-size="${size}"]`).classList.add('selected');
            }
            
            toggleShipOrientation() {
                this.shipOrientation = this.shipOrientation === 'horizontal' ? 'vertical' : 'horizontal';
                document.getElementById('rotateBtn').textContent = `–ü–æ–≤–µ—Ä–Ω—É—Ç—å: ${this.shipOrientation === 'horizontal' ? '–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ' : '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ'}`;
            }
            
            confirmShipPlacement() {
                if (this.playerShips.length !== 10) {
                    this.showError('–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏!');
                    return;
                }
                this.sendMessage({ type: 'place_ships', ships: this.playerShips });
            }
            
            placeShipOnBoard(x, y) {
                if (!this.currentShip || this.gameState !== 'placement') return;
                if (this.canPlaceShip(x, y, this.currentShip, this.shipOrientation)) {
                    this.playerShips.push({
                        size: this.currentShip,
                        x: x,
                        y: y,
                        isHorizontal: this.shipOrientation === 'horizontal'
                    });
                    const shipElement = document.querySelector(`.ship-item[data-size="${this.currentShip}"]`);
                    shipElement.classList.add('placed');
                    shipElement.classList.remove('selected');
                    this.currentShip = null;
                    this.renderBoards();
                }
            }
            
            canPlaceShip(x, y, size, orientation) {
                if (orientation === 'horizontal') return x + size <= 10;
                else return y + size <= 10;
            }
            
            shoot(x, y) {
                if (this.gameState === 'battle' && this.isMyTurn) {
                    this.sendMessage({ type: 'shoot', x: x, y: y });
                }
            }
            
            renderBoards() {
                this.renderPlayerBoard();
                this.renderOpponentBoard();
            }
            
            renderPlayerBoard() {
                const board = document.getElementById('playerBoard');
                board.innerHTML = '';
                for (let y = 0; y < 10; y++) {
                    for (let x = 0; x < 10; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        const ship = this.playerShips.find(s => {
                            for (let i = 0; i < s.size; i++) {
                                const shipX = s.isHorizontal ? s.x + i : s.x;
                                const shipY = s.isHorizontal ? s.y : s.y + i;
                                if (shipX === x && shipY === y) return true;
                            }
                            return false;
                        });
                        if (ship) cell.classList.add('ship');
                        cell.addEventListener('click', () => {
                            if (this.gameState === 'placement') this.placeShipOnBoard(x, y);
                        });
                        board.appendChild(cell);
                    }
                }
            }
            
            renderOpponentBoard() {
                const board = document.getElementById('opponentBoard');
                board.innerHTML = '';
                for (let y = 0; y < 10; y++) {
                    for (let x = 0; x < 10; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        cell.addEventListener('click', () => {
                            if (this.gameState === 'battle' && this.isMyTurn) this.shoot(x, y);
                        });
                        board.appendChild(cell);
                    }
                }
            }
            
            showLobby() {
                document.getElementById('lobbyView').classList.remove('hidden');
                document.getElementById('gameView').classList.add('hidden');
                document.getElementById('leaveRoomBtn').classList.add('hidden');
                this.gameState = 'lobby';
                this.playerShips = [];
                this.currentShip = null;
            }
            
            showGame() {
                document.getElementById('lobbyView').classList.add('hidden');
                document.getElementById('gameView').classList.remove('hidden');
                document.getElementById('leaveRoomBtn').classList.remove('hidden');
            }
            
            sendMessage(message) {
                if (this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            }
            
            showError(message) {
                alert('–û—à–∏–±–∫–∞: ' + message);
            }
            
            showMessage(message) {
                alert(message);
            }
        }
        
        window.addEventListener('load', () => new BattleshipGame());
    </script>
</body>
</html>